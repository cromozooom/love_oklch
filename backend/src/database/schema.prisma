// This is your Prisma schema file for Love OKLCH Freemium Entitlement System
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum SubscriptionStatus {
  active
  expired
  canceled
  pending
  grace_period

  @@map("subscription_status")
}

enum PaymentType {
  recurring
  one_time

  @@map("payment_type")
}

enum AdminRoleType {
  super_admin
  plan_manager
  billing_admin
  support_admin

  @@map("admin_role_type")
}

// Models
model User {
  userId      String   @id @default(dbgenerated("uuid_generate_v4()")) @map("user_id") @db.Uuid
  email       String   @unique @db.VarChar(255)
  passwordHash String? @map("password_hash") @db.VarChar(255)
  name        String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive    Boolean  @default(true) @map("is_active")

  // Relations
  subscriptions Subscription[]
  adminRoles    AdminRole[]
  featureUsage  FeatureUsage[]
  grantedRoles  AdminRole[]    @relation("GrantedBy")

  @@map("users")
}

model Plan {
  planId          String   @id @default(dbgenerated("uuid_generate_v4()")) @map("plan_id") @db.Uuid
  name            String   @unique @db.VarChar(100)
  slug            String   @unique @db.VarChar(100)
  description     String?
  price           Decimal  @default(0.00) @db.Decimal(10, 2)
  currency        String   @default("USD") @db.VarChar(3)
  billingInterval String?  @map("billing_interval") @db.VarChar(20) // 'monthly', 'yearly', 'one_time', null for free
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  subscriptions Subscription[]
  planFeatures  PlanFeature[]

  @@map("plans")
}

model Feature {
  featureId        String   @id @default(dbgenerated("uuid_generate_v4()")) @map("feature_id") @db.Uuid
  keyName          String   @unique @map("key_name") @db.VarChar(100)
  displayName      String   @map("display_name") @db.VarChar(255)
  description      String?
  category         String?  @db.VarChar(100)
  isBoolean        Boolean  @default(false) @map("is_boolean") // true for on/off, false for limits/quotas
  defaultValue     Json     @default("{}") @map("default_value")
  validationSchema Json?    @map("validation_schema") // JSON schema for value validation
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  planFeatures PlanFeature[]
  featureUsage FeatureUsage[]

  @@map("features")
}

model Subscription {
  subscriptionId         String             @id @default(dbgenerated("uuid_generate_v4()")) @map("subscription_id") @db.Uuid
  userId                 String             @map("user_id") @db.Uuid
  planId                 String             @map("plan_id") @db.Uuid
  status                 SubscriptionStatus @default(pending)
  paymentType            PaymentType        @default(recurring) @map("payment_type")
  startDate              DateTime           @default(now()) @map("start_date") @db.Timestamptz(6)
  endDate                DateTime?          @map("end_date") @db.Timestamptz(6)
  gracePeriodEnd         DateTime?          @map("grace_period_end") @db.Timestamptz(6)
  trialEndDate           DateTime?          @map("trial_end_date") @db.Timestamptz(6)
  billingCycleAnchor     DateTime?          @map("billing_cycle_anchor") @db.Timestamptz(6)
  externalSubscriptionId String?            @map("external_subscription_id") @db.VarChar(255)
  metadata               Json               @default("{}")
  createdAt              DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user         User           @relation(fields: [userId], references: [userId], onDelete: Cascade)
  plan         Plan           @relation(fields: [planId], references: [planId], onDelete: Restrict)
  featureUsage FeatureUsage[]

  // Indexes
  @@index([userId, status], map: "idx_subscriptions_user_status")
  @@index([status, endDate, gracePeriodEnd], map: "idx_subscriptions_status_dates")
  @@map("subscriptions")
}

model PlanFeature {
  planFeatureId String   @id @default(dbgenerated("uuid_generate_v4()")) @map("plan_feature_id") @db.Uuid
  planId        String   @map("plan_id") @db.Uuid
  featureId     String   @map("feature_id") @db.Uuid
  value         Json     @default("{}")
  isEnabled     Boolean  @default(true) @map("is_enabled")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  plan    Plan    @relation(fields: [planId], references: [planId], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [featureId], onDelete: Cascade)

  // Constraints
  @@unique([planId, featureId])
  @@index([planId], map: "idx_plan_features_plan_id")
  @@map("plan_features")
}

model AdminRole {
  roleId    String        @id @default(dbgenerated("uuid_generate_v4()")) @map("role_id") @db.Uuid
  userId    String        @map("user_id") @db.Uuid
  roleName  AdminRoleType @map("role_name")
  permissions Json        @default("{}")
  grantedBy String?       @map("granted_by") @db.Uuid
  grantedAt DateTime      @default(now()) @map("granted_at") @db.Timestamptz(6)
  expiresAt DateTime?     @map("expires_at") @db.Timestamptz(6)
  isActive  Boolean       @default(true) @map("is_active")
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user    User  @relation(fields: [userId], references: [userId], onDelete: Cascade)
  granter User? @relation("GrantedBy", fields: [grantedBy], references: [userId])

  // Indexes
  @@index([userId, isActive], map: "idx_admin_roles_user_active")
  @@map("admin_roles")
}

model FeatureUsage {
  usageId        String    @id @default(dbgenerated("uuid_generate_v4()")) @map("usage_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  featureId      String    @map("feature_id") @db.Uuid
  subscriptionId String?   @map("subscription_id") @db.Uuid
  usageCount     Int       @default(0) @map("usage_count")
  usageData      Json      @default("{}") @map("usage_data")
  periodStart    DateTime  @default(now()) @map("period_start") @db.Timestamptz(6)
  periodEnd      DateTime? @map("period_end") @db.Timestamptz(6)
  lastResetAt    DateTime  @default(now()) @map("last_reset_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user         User          @relation(fields: [userId], references: [userId], onDelete: Cascade)
  feature      Feature       @relation(fields: [featureId], references: [featureId], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [subscriptionId], onDelete: SetNull)

  // Indexes
  @@index([userId, featureId], map: "idx_feature_usage_user_feature")
  @@map("feature_usage")
}